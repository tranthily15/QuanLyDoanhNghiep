@model IEnumerable<QuanLyDoanhNghiep.Models.Notification>

@{
    ViewData["Title"] = "Thông báo";
}
<div class="box"></div>
<div class="container">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-bell me-2"></i>Tất cả thông báo
                        </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm" id="markAllRead">
                                <i class="fas fa-check-double me-1"></i>Đánh dấu đã đọc tất cả
                            </button>
                            <button class="btn btn-outline-danger btn-sm" id="deleteAll">
                                <i class="fas fa-trash-alt me-1"></i>Xóa tất cả
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-1">
                    <div class="notification-list">
                        @if (Model != null && Model.Any())
                        {
                            var unreadNotifications = Model.Where(n => !n.IsRead).ToList();
                            var readNotifications = Model.Where(n => n.IsRead).ToList();

                            if (unreadNotifications.Any())
                            {
                                <div class="notification-section">
                                    <div class="notification-section-header">
                                        <h6 class="mb-0">Thông báo chưa đọc</h6>
                                    </div>
                                    @foreach (var notification in unreadNotifications)
                                    {
                                        <div class="notification-item unread" data-id="@notification.NotificationID" data-path="@notification.NotificationPath">
                                            <div class="notification-content">
                                                <div class="d-flex align-items-start">
                                                    <div class="notification-icon me-3">
                                                        <i class="fas fa-bell"></i>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div class="notification-text">
                                                                @notification.Message
                                                            </div>
                                                            <div class="notification-actions">
                                                                <button class="btn btn-link btn-sm mark-read" data-id="@notification.NotificationID">
                                                                    <i class="fas fa-check"></i>
                                                                </button>
                                                                <button class="btn btn-link btn-sm text-danger delete-notification" data-id="@notification.NotificationID">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="notification-meta">
                                                            <small class="text-muted">
                                                                <i class="far fa-clock me-1"></i>
                                                                @notification.CreatedAt.ToString("HH:mm dd/MM/yyyy")
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }

                            if (readNotifications.Any())
                            {
                                <div class="notification-section">
                                    <div class="notification-section-header">
                                        <h6 class="mb-0">Thông báo đã đọc</h6>
                                    </div>
                                    @foreach (var notification in readNotifications)
                                    {
                                        <div class="notification-item read" data-id="@notification.NotificationID" data-path="@notification.NotificationPath">
                                            <div class="notification-content">
                                                <div class="d-flex align-items-start">
                                                    <div class="notification-icon me-3">
                                                        <i class="fas fa-bell"></i>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div class="notification-text">
                                                                @notification.Message
                                                            </div>
                                                            <div class="notification-actions">
                                                                <button class="btn btn-link btn-sm text-danger delete-notification" data-id="@notification.NotificationID">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="notification-meta">
                                                            <small class="text-muted">
                                                                <i class="far fa-clock me-1"></i>
                                                                @notification.CreatedAt.ToString("HH:mm dd/MM/yyyy")
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                                <p class="text-muted mb-0">Không có thông báo nào</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.notification-list {
    max-height: 1500px;
    overflow-y: auto;
}

.notification-section {
    border-bottom: 1px solid #e9ecef;
}

.notification-section:last-child {
    border-bottom: none;
}

.notification-section-header {
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

.notification-item {
    padding: 2rem;
    transition: background-color 0.2s;
}

.notification-item:hover {
    background-color: #f8f9fa;
}

.notification-item.unread {
    background-color: #f1f8ff;
}

.notification-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #e4e6eb;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.notification-icon i {
    font-size: 18px;
    color: #1877f2;
}

.notification-text {
    color: #1c1e21;
    font-size: 14px;
    line-height: 1.4;
    margin-bottom: 4px;
}

.notification-meta {
    font-size: 12px;
}

.notification-actions {
    opacity: 0;
    transition: opacity 0.2s;
}

.notification-item:hover .notification-actions {
    opacity: 1;
}

.btn-link {
    padding: 0.25rem;
    color: #65676b;
}

.btn-link:hover {
    color: #1877f2;
}

.btn-link.text-danger:hover {
    color: #dc3545;
}

/* Custom scrollbar */
.notification-list::-webkit-scrollbar {
    width: 6px;
}

.notification-list::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.notification-list::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.notification-list::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Click vào thông báo
            $('.notification-item').click(function(e) {
                if (!$(e.target).closest('.notification-actions').length) {
                    var notificationId = $(this).data('id');
                    var notificationPath = $(this).data('path');
                    
                    // Mark as read first
                    $.post('/Notification/MarkAsRead', { id: notificationId }, function(response) {
                        if (response.success) {
                            // Update UI
                            var $item = $(this);
                            $item.removeClass('unread').addClass('read');
                            updateNotificationCount();
                            
                            // Navigate to the notification path if exists
                            if (notificationPath) {
                                // Đảm bảo đường dẫn bắt đầu bằng /
                                if (!notificationPath.startsWith('/')) {
                                    notificationPath = '/' + notificationPath;
                                }
                                window.location.href = notificationPath;
                            }
                        }
                    }.bind(this)).fail(function() {
                        console.error('Failed to mark notification as read');
                    });
                }
            });

            // Mark all as read
            $('#markAllRead').click(function() {
                $.post('/Notification/MarkAllAsRead', function(response) {
                    if (response.success) {
                        $('.notification-item').removeClass('unread').addClass('read');
                        $('.mark-read').remove();
                        updateNotificationCount();
                        
                        // Remove unread section
                        $('.notification-section:first').remove();
                    }
                });
            });

            // Delete single notification
            $('.delete-notification').click(function(e) {
                e.preventDefault();
                var notificationId = $(this).data('id');
                var $item = $(this).closest('.notification-item');
                var $section = $item.closest('.notification-section');
                
                if (confirm('Bạn có chắc muốn xóa thông báo này?')) {
                    $.post('/Notification/Delete', { id: notificationId }, function(response) {
                        if (response.success) {
                            $item.fadeOut(300, function() {
                                $(this).remove();
                                
                                // Remove section if empty
                                if ($section.find('.notification-item').length === 0) {
                                    $section.remove();
                                }
                                
                                // Show empty state if no notifications left
                                if ($('.notification-item').length === 0) {
                                    $('.notification-list').html(`
                                        <div class="text-center py-5">
                                            <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                                            <p class="text-muted mb-0">Không có thông báo nào</p>
                                        </div>
                                    `);
                                }
                            });
                            updateNotificationCount();
                        }
                    });
                }
            });

            // Delete all notifications
            $('#deleteAll').click(function() {
                if (confirm('Bạn có chắc muốn xóa tất cả thông báo?')) {
                    $.post('/Notification/DeleteAll', function(response) {
                        if (response.success) {
                            $('.notification-list').html(`
                                <div class="text-center py-5">
                                    <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                                    <p class="text-muted mb-0">Không có thông báo nào</p>
                                </div>
                            `);
                            updateNotificationCount();
                        }
                    });
                }
            });

            // Update notification count in header
            function updateNotificationCount() {
                $.get('/Notification/GetUnreadCount', function(data) {
                    if (data.count > 0) {
                        $('#notificationCount').text(data.count).show();
                    } else {
                        $('#notificationCount').hide();
                    }
                });
            }
        });
    </script>
}